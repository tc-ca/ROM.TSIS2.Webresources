<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables/dist/js/tabulator.min.js"></script>

    <!-- Package used for the table - Tabulator -->
    <!-- http://tabulator.info/ -->

</head>
<body onload="loadTable()">
    <div class="container-fluid">
        <strong style="margin-top:10px;margin-left:5px">
            <label id="numberOfFilesSelected">Number of files selected:</label>
        </strong>
        <strong style="margin-top:10px;margin-left:5px">
            <label id="RowCounterLabel">0</label>
        </strong>
        <button id="selectAll" class="btn btn-default" style="margin-left: 20px; margin-top:10px">Select All</button>
        <button id="deselectAll" class="btn btn-default" style="margin-left: 10px; margin-top:10px">Deselect All</button>
        <div class="row" style="margin-top: 10px; margin-left: 10px; margin-right: 10px">
            <div id="example-table" />
        </div>
        <div class="row" style="margin-left: 5px;margin-top: 10px">
            <button id="uploadFiles" class="btn btn-default" onclick="UploadAttachments()">Attach File(s)</button>
        </div>
    </div>

    <script type="text/javascript">

        let allFiles = [];
        let selectedEncodedFiles = [];
        let table = null;

        let tableAlertMessage = "Attaching Files";
        let filesSelectedHeading = "Number of files selected:";
        let selectAllButtonText = "Select All";
        let deselectAllButtonText = "Deselect All";
        let fileNameColumnHeader = "File Name";
        let fileNameColumnHeaderWidth = 750;
        let attachFileColumnHeader = "Attach File";
        let attachFileButtonText = "Attach File(s)";
        const USER_LANG_FR = 1036;
        let userLocalLanguage = "";
        let unableToGetFilesError = "Unable to get files";
        const protectedBSensitivityLevel = 717750001;
        let unableToAttachProdBFile = "Unable to attach a Protected B file";

        function setLanguage() {

            // find out if the users language setting is set to French
            var currentLanguage = parent.Xrm.Page.context.getUserLcid();

            if (currentLanguage == USER_LANG_FR) {
                tableAlertMessage = "Joindre des fichiers";
                filesSelectedHeading = "Nombre de fichiers sélectionnés:";
                selectAllButtonText = "Sélectionner tout";
                deselectAllButtonText = "Déselectionner tout";
                fileNameColumnHeader = "Nom du fichier";
                fileNameColumnHeaderWidth = 710;
                attachFileColumnHeader = "Joindre un fichier";
                attachFileButtonText = "Joindre des fichier(s)";
                userLocalLanguage = "fr-fr";
                unableToGetFilesError = "Impossible d'obtenir les fichiers";
                unableToAttachProdBFile = "Impossible de joindre un fichier protégé B";
            }

            // set the button text
            document.getElementById('selectAll').innerHTML = selectAllButtonText;
            document.getElementById('deselectAll').innerHTML = deselectAllButtonText;
            document.getElementById('uploadFiles').innerHTML = attachFileButtonText;

            // set the number of files selected header
            document.getElementById('numberOfFilesSelected').innerHTML = filesSelectedHeading;
        }

        function loadTable() {

            setLanguage();

            // initially disable the Attach Files button
            document.getElementById("uploadFiles").disabled = true;

            // retrieve all the files that are in the file entity
            {
                parent.Xrm.WebApi.retrieveMultipleRecords("ts_file", "?$select=ts_fileid,ts_file,ts_sensitivitylevel").then(

                    function success(result) {

                        // retrieve all the files that are in the document centre
                        for (var i = 0; i < result.entities.length; i++) {

                            // create the file object
                            var myFile = {
                                id: result.entities[i].ts_fileid,
                                fileName: result.entities[i].ts_file,
                                sensitivityLevel: result.entities[i].ts_sensitivitylevel,
                                encodedFileData: ""
                            };

                            allFiles[i] = myFile;
                        }

                        //define the table data
                        table = new Tabulator("#example-table", {
                            data: allFiles,
                            layout: "fitColumns",
                            pagination: "local",
                            paginationSize: 10,
                            locale: userLocalLanguage,
                            langs: {
                                "fr-fr": { //French language definition
                                    "columns": {
                                        "id": "ID",
                                        "fileName": fileNameColumnHeader,
                                        "attachFile": attachFileColumnHeader,
                                    },
                                    "pagination": {
                                        "first": "Premier",
                                        "last": "Dernier",
                                        "prev": "Précédent",
                                        "next": "Suivant",
                                    },
                                },
                            },
                            initialSort: [
                                { column: "fileName", dir: "asc" },
                            ],
                            columns: [
                                { title: "ID", field: "id", sorter: "string", width: 200, editor: true, visible: false },
                                { title: fileNameColumnHeader, field: "fileName", sorter: "string", width: fileNameColumnHeaderWidth, headerFilter: "input" },
                                { title: attachFileColumnHeader, field: "attachFile", formatter: "rowSelection", hozAlign: "center", vertAlign: "center", headerSort: false },
                            ],
                        });

                        //keep track of how many files have been selected
                        table.on("rowSelectionChanged", async function (data, rows) {

                            document.getElementById('RowCounterLabel').innerHTML = data.length;

                            var rowIsSelected = data.length > 0 ? true : false;

                            var protectedBFileFound = false;

                            // Check if any of the selected items is a Protected B document
                            {
                                if (rowIsSelected) {

                                    for (var i = 0; i < data.length; i++) {

                                        if (data[i].sensitivityLevel == protectedBSensitivityLevel) {

                                            var selectedRowGuid = data[i].id;
                                            var selectedRowIndex = table.getRowPosition(selectedRowGuid);

                                            // deselect the selected file
                                            table.deselectRow(selectedRowGuid);

                                            protectedBFileFound = true;
                                        }
                                    }

                                    if (protectedBFileFound) {

                                        // show the message to the user for a brief moment
                                        // we do it this way incase the user uses the Select All button
                                        table.alert(unableToAttachProdBFile);

                                        await delay(2);

                                        table.clearAlert();
                                    }
                                }
                            }

                            // Enable or disable the upload button
                            {
                                if (rowIsSelected) {
                                    document.getElementById("uploadFiles").disabled = false;
                                } else {
                                    document.getElementById("uploadFiles").disabled = true;
                                }
                            }

                        });

                        //select all records
                        document.getElementById("selectAll").addEventListener("click", function () {
                            table.selectRow();
                        });

                        //deselect all records
                        document.getElementById("deselectAll").addEventListener("click", function () {
                            table.deselectRow();
                        });
                    },
                    function (error) {
                        // handle error conditions
                        alert(unableToGetFilesError);
                        console.log("Error retrieving files: " + error.message);
                        window.close();
                    }
                );
            }
        }

        async function UploadAttachments() {

            // show the alert
            table.alert(tableAlertMessage);

            // disable the button
            document.getElementById("uploadFiles").disabled = true;

            // have a delay so the message actually shows
            await delay(1);

            // get the ID of the selected email
            var queryString = window.location.search;
            var urlParams = new URLSearchParams(queryString);
            var emailID = urlParams.get('data')

            // go through each selected file and upload it as an attachment to the email
            {
                var selectedFiles = table.getSelectedData();

                // call the API and get the encoding for each file
                for (var i = 0; i < selectedFiles.length; i++) {

                    var fileID = selectedFiles[i].id;
                    var getRequest = new XMLHttpRequest();

                    getRequest.open("GET", parent.Xrm.Page.context.getClientUrl() + "/api/data/v9.0/ts_files(" + fileID + ")/ts_attachment/", false);
                    getRequest.setRequestHeader("OData-MaxVersion", "4.0");
                    getRequest.setRequestHeader("OData-Version", "4.0");

                    getRequest.onreadystatechange = function () {

                        if (this.readyState === 4) {
                            getRequest.onreadystatechange = null;

                            if (this.status === 200) {
                                var result = JSON.parse(this.response);
                                selectedFiles[i].encodedFileData = result.value;

                                console.log("Success getting the encoding for tsfileid " + fileID + " Message: " + this.statusText);
                            }
                            else {
                                // display an error message to the console
                                console.log("Error getting the encoding for tsfileid " + fileID + " Reason: " + this.statusText);
                            }
                        }
                    };

                    getRequest.send();
                }

                // upload each file to the Attachment (activitymimeattachments) entity
                for (var i = 0; i < selectedFiles.length; i++) {

                    var activityType = "email"
                    var attachment = {};

                    attachment["objectid_activitypointer@odata.bind"] = "/activitypointers(" + emailID + ")";
                    attachment.body = selectedFiles[i].encodedFileData
                    attachment.filename = selectedFiles[i].fileName;
                    attachment.objecttypecode = activityType;

                    var postRequest = new XMLHttpRequest();
                    postRequest.open("POST", parent.Xrm.Page.context.getClientUrl() + "/api/data/v9.0/activitymimeattachments", false);
                    postRequest.setRequestHeader("OData-MaxVersion", "4.0");
                    postRequest.setRequestHeader("OData-Version", "4.0");
                    postRequest.setRequestHeader("Accept", "application/json");
                    postRequest.setRequestHeader("Content-Type", "application/json; charset=utf-8");

                    postRequest.onreadystatechange = function () {
                        if (this.readyState === 4) {
                            postRequest.onreadystatechange = null;
                            if (this.status === 204) {
                                console.log("Success uploading the attachment FileName: " + selectedFiles[i].fileName + " Message: " + this.statusText);
                            } else {
                                // display an error message to the console
                                console.log("Error uploading the attachment FileName: " + selectedFiles[i].fileName + " Reason: " + this.statusText);
                            }
                        }
                    };
                    postRequest.send(JSON.stringify(attachment));
                }
            }

            // close the alert
            table.clearAlert();

            window.close();
        }

        function delay(n) {
            return new Promise(function (resolve) {
                setTimeout(resolve, n * 1000);
            });
        }

    </script>
</body>
</html>