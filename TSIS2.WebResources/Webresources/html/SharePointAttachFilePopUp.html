<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables/dist/js/tabulator.min.js"></script>
    <link href="https://unpkg.com/filepond@^4/dist/filepond.css" rel="stylesheet" />
    <script src="https://unpkg.com/filepond@^4/dist/filepond.js"></script>
    <style>
        /* the border radius of the drop area */
        .filepond--panel-root {
            border: 2px solid black;
            border-radius: 0.5em;
            padding: 5em;
            /* margin-top: 10em; */
        }

        .filepond--item {
            width: calc(50% - 0.5em);
        }
    </style>

    <!-- Package used for the table - Tabulator -->
    <!-- http://tabulator.info/ -->
    <!-- Package used for uploading -->
    <!-- https://pqina.nl/filepond/-->
</head>
<body onload="loadForm()">

    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-6">
                <button id="clearAttachments" class="btn btn-default" style="margin-left: 10px; margin-top:10px" onclick="clearAttachments()"></button>
            </div>
            <div class="col-sm-6">
                <button id="uploadAttachments" class="btn btn-default" style="margin-left: 10px; margin-top:10px" onclick="uploadAttachments()">Upload files</button>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12 ">
                <input id="my-filepond" type="file" class="filepond" name="filepond" multiple>
            </div>
        </div>
        <div class="row" style="margin-top:120px">
            <div class="col-sm-12">
                <div class="form-group">
                    <label for="fileDescription">Description:</label>
                    <textarea class="form-control" rows="5" id="fileDescription">Some random text about this file.</textarea>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12">
                <div class="form-group">
                    <label for="fileCategories">Category:</label>
                    <select class="form-control" id="fileCategories">
                        <!-- Options will be populated here -->
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Code-->
    <script type="text/javascript">
        let recordId = "";
        let recordOwnerName = "";
        let sharePointFileGroupID = "";
        let sharePointFileID = "";
        let sharePointQuery = "";
        let tableNameEnglish = "";
        let tableNameFrench = "";
        let tableRecordName = "";
        let tableSchemaName = "";
        let useGroupFiles = false;
        let userLanguage = 1033;
        let usersManagerEmail = "";
        let usersEmail = "";

        // Label Text
        let noFilesText = "";
        let clearAttachmentsButtonText = "";
        let fileCategoryListText = "";
        let descriptionText = "";

        // User Input
        let selectedFileCategory = null;
        let descriptionInputText = null;

        // Define FilePond globally
        let pond;

        function loadForm() {

            // Parse the query string
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);

            // Access the 'data' parameter
            const jsonString = urlParams.get('data');

            try {

                // Make sure the JSON string is not empty
                if (jsonString) {

                    // Parse the JSON string to an object
                    const jsonData = JSON.parse(jsonString);

                    // Populate the variables
                    recordId = jsonData.recordId;
                    recordOwnerName = jsonData.recordOwnerName;
                    sharePointFileGroupID = jsonData.sharePointFileGroupID;
                    sharePointFileID = jsonData.sharePointFileID;
                    sharePointQuery = jsonData.sharePointQuery;
                    tableNameEnglish = jsonData.tableNameEnglish;
                    tableNameFrench = jsonData.tableNameFrench;
                    tableRecordName = jsonData.tableRecordName;
                    tableSchemaName = jsonData.tableSchemaName;
                    useGroupFiles = jsonData.useGroupFiles;
                    userLanguage = jsonData.userLanguage;
                    usersManagerEmail = jsonData.usersManagerEmail;
                    usersEmail = jsonData.usersEmail

                    // Set the language for all the labels
                    setLanguage();

                    // Initialize File Pond
                    initializeFilePond();

                    // Get File Categories
                    getFileCategories();

                    // Setup the listener for the Categories drop down
                    const dropdown = document.getElementById('fileCategories');

                    dropdown.addEventListener('change', function () {

                        const selectedOption = dropdown.options[dropdown.selectedIndex];
                        selectedFileCategory = selectedOption.value;
                    });
                }
                else {
                    console.error("The JSON string is empty");
                    alert("There is an error populating variables for the JSON string - the JSON string is empty");
                }
            } catch (error) {
                console.error("ROM Error:", error);
                alert("ROM Error:" + " " + error);
            }
        }

        function setLanguage() {

            // Set French labels
            if (userLanguage == 1036) {
                noFilesText = "Faites glisser les fichiers ici ou cliquez pour les joindre.";
                clearAttachmentsButtonText = "Effacer les pièces jointes";
                descriptionText = "Description";
                fileCategoryListText = "Catégorie";
            }
            // Set English labels by default
            else {
                noFilesText = "Drag file(s) here or click to attach.";
                clearAttachmentsButtonText = "Clear Attachments";
                descriptionText = "Description";
                fileCategoryListText = "Category";
            }

            // Set the button text
            document.getElementById('clearAttachments').innerHTML = clearAttachmentsButtonText;

            // Add accessibility label and tooltip
            document.getElementById('clearAttachments').setAttribute('title', clearAttachmentsButtonText);
            document.getElementById('clearAttachments').setAttribute('aria-label', clearAttachmentsButtonText);
        }

        function initializeFilePond() {
            const inputElement = document.querySelector('input[type="file"]');

            pond = FilePond.create(inputElement, {
                labelIdle: `${noFilesText}`,
                maxFiles: 5
            });
        }

        function clearAttachments() {

            // To clear all files from FilePond
            if (pond) {
                pond.removeFiles();
            } else {
                console.error("FilePond is not initialized");
            }
        }

        function uploadAttachments() {

            // Get user input
            descriptionInputText = document.getElementById('fileDescription').value;

            // Upload attachments
            if (pond) {

                const files = pond.getFiles();
                const colFiles = [];

                files.forEach(fileItem => {
                    const file = fileItem.file;
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const fileContent = event.target.result;
                        const base64Content = btoa(fileContent); // Convert to base64
                        const fileJson = {
                            base64: base64Content,
                            Name: file.name,
                            tags: "your_tags_here" // Add your tags here
                        };
                        colFiles.push(fileJson);

                        // If all files are read, call the Power Automate flow
                        if (colFiles.length === files.length) {
                            //callPowerAutomateFlow(colFiles);
                            uploadFilesToDocumentLibrary(colFiles);

                        }
                    };
                    reader.readAsBinaryString(file);
                });

            } else {
                console.error("FilePond is not initialized");
            }
        }

        async function getEnvironmentVariableByName(variableName) {
            let variableValue = "";

            const fetchXML = `
                        <fetch>
                            <entity name="environmentvariablevalue">
                                <attribute name="value" />
                                <link-entity name="environmentvariabledefinition" to="environmentvariabledefinitionid" from="environmentvariabledefinitionid" alias="environmentvariabledefinition" link-type="inner">
                                    <filter>
                                        <condition attribute="schemaname" operator="eq" value="${variableName}" />
                                    </filter>
                                </link-entity>
                            </entity>
                        </fetch>
                    `;

            const encodedFetchXml = encodeURIComponent(fetchXML);

            while (true) {
                try {
                    const result = await parent.Xrm.WebApi.retrieveMultipleRecords("environmentvariablevalue", "?fetchXml=" + encodedFetchXml);
                    if (result.entities.length > 0) {
                        variableValue = result.entities[0].value;
                        return variableValue;
                    } else {
                        console.log(`Environment variable ${variableName} not found.`);
                        return variableValue;
                    }
                } catch (error) {
                    console.error("Error retrieving environment variable: " + error.message);
                    throw error;
                }

                await new Promise(resolve => setTimeout(resolve, 500)); // wait for 500ms before next check
            }
        }

        async function getFileCategories() {
            let flowKey = null;
            let flowURL = null;
            let result = null;

            // Wait for securityToken and flowURL to be retrieved
            flowKey = await getEnvironmentVariableByName("ts_SharePointFlowKey");
            flowURL = await getEnvironmentVariableByName("ts_URLSharePointGetFileCategories");

            if (!flowKey || !flowURL) {
                console.log('Flow Key or Flow URL is null');
                return false;
            }

            // get the file categories
            result = await runSharePointGetFileCategoriesFlow(flowKey, flowURL);
        }

        async function runSharePointGetFileCategoriesFlow(flowKey, flowURL) {
            if (!flowKey || !flowURL) {
                console.log('Flow Key or Flow URL is null');
                return false;
            }

            const data = {
                RecordOwner: recordOwnerName
            };

            try {
                const response = await fetch(flowURL, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "FlowKey": flowKey,
                        "RecordOwner": recordOwnerName
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Success:', result);
                    const categoriesList = result.value.map(item => ({
                        ID: item.ID,
                        Title: item.Title,
                        Cat_x00e9_gorie: item.Cat_x00e9_gorie
                    }));

                    let sortedCategoriesList = null;

                    if (userLanguage == 1036) {

                        // French
                        sortedCategoriesList = categoriesList.sort((a, b) => a.Cat_x00e9_gorie.localeCompare(b.Cat_x00e9_gorie));
                    }
                    else {

                        // English
                        sortedCategoriesList = categoriesList.sort((a, b) => a.Title.localeCompare(b.Title));
                    }

                    
                    const dropdown = document.getElementById('fileCategories');

                    // Clear existing options
                    dropdown.innerHTML = ''; 

                    var firstLoop = true;

                    // populate the drop down
                    sortedCategoriesList.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.ID;

                        if (userLanguage == 1036) {

                            // French Label
                            option.textContent = category.Cat_x00e9_gorie;
                        }
                        else {

                            // English Label
                            option.textContent = category.Title;
                        }

                        dropdown.appendChild(option);

                        // select the first item
                        if (firstLoop) {
                            selectedFileCategory = category.ID;
                        }

                        firstLoop = false;
                    });


                    return true;
                } else {
                    console.error('Error:', response.statusText);
                    return false;
                }
            } catch (error) {
                console.error('Error:', error);
                return false;
            }
        }

        async function runSharePointUploadFilesToDocumentLibraryFlow(flowKey, flowURL, jsonFileContent) {
            if (!flowKey || !flowURL) {
                console.log('Flow Key or Flow URL is null');
                return false;
            }

            const data = {
                RecordID: recordId,
                RecordOwner: recordOwnerName,
                DocumentReferenceID: tableRecordName,
                Description: descriptionInputText,
                FileContentJSON: jsonFileContent,
                TableNameEnglish: tableNameEnglish,
                TableNameFrench: tableNameFrench,
                CategoryID: selectedFileCategory.toString(),
                SharePointFileID: sharePointFileID,
                ManagerEmail: usersManagerEmail,
                UserEmail: usersEmail
            };

            try {
                const response = await fetch(flowURL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "FlowKey": flowKey
                    }
                    ,body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.status;
                    console.log('Success:', result);
                    return true;
                } else {
                    console.error('Error:', response.statusText);
                    return false;
                }
            } catch (error) {
                console.error('Error:', error);
                return false;
            }
        }

        async function uploadFilesToDocumentLibrary(jsonFileContent) {
            let flowKey = null;
            let flowURL = null;
            let result = null;

            // Wait for securityToken and flowURL to be retrieved
            flowKey = await getEnvironmentVariableByName("ts_SharePointFlowKey");
            flowURL = await getEnvironmentVariableByName("ts_URLSharePointUploadFilestoDocumentLibrary");

            if (!flowKey || !flowURL) {
                console.log('Flow Key or Flow URL is null');
                return false;
            }

            result = await runSharePointUploadFilesToDocumentLibraryFlow(flowKey, flowURL, jsonFileContent);

            // clear the list
            if (result) {
                clearAttachments();
            }
        }

    </script>
</body>
</html>